-- Nightmice x ChatGPT (versão Discord + binds + cleanup + Ilha Específica + Tema)

local Player = game:GetService("Players").LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Character
local Humanoid
local connections = {} -- para guardar todos os Connects

-- Armazena o tema atual (começa com o tema Discord)
local currentTheme = "Discord"

-- Tabela de Configuração dos Temas
local THEMES = {
	-- Tema Original: Estilo Dark/Discord
	Discord = {
		FrameBG = Color3.fromRGB(54, 57, 63),
		TextPrimary = Color3.fromRGB(255, 255, 255),
		TextSecondary = Color3.fromRGB(180, 180, 180),
		ButtonTP = Color3.fromRGB(88, 101, 242), -- Azul
		ButtonRefresh = Color3.fromRGB(67, 181, 129), -- Verde
		ButtonClose = Color3.fromRGB(237, 66, 69), -- Vermelho
		ButtonTheme = Color3.fromRGB(250, 166, 26), -- Laranja/Amarelo
		CornerRadius = UDim.new(0, 8),
		ButtonCorner = UDim.new(0, 6),
		StrokeColor = Color3.fromRGB(40, 42, 46), -- Borda sutil
		StrokeThickness = 1,
		StrokeTransparency = 0
	},
	-- NOVO TEMA: Estilo Oeste (Western) com ripas/painéis (cores e stroke)
	Western = {
		FrameBG = Color3.fromRGB(206, 160, 109), -- Tonalidade do Marrom Claro (fundo esquerdo)

		-- Cores de Texto (Alteradas para Branco Puro)
		TextPrimary = Color3.fromRGB(255, 255, 255), -- Branco Puro para Títulos/Status
		TextSecondary = Color3.fromRGB(255, 255, 255),-- Branco Puro para Rótulos

		-- Cores de Botão e Borda, baseadas no Marrom Escuro (formas arredondadas direitas)
		ButtonTP = Color3.fromRGB(143, 109, 74), -- Marrom Escuro (para contraste)
		ButtonRefresh = Color3.fromRGB(143, 109, 74), -- Marrom Escuro
		ButtonClose = Color3.fromRGB(255, 0, 0), -- Marrom Escuro
		ButtonTheme = Color3.fromRGB(143, 109, 74), -- Marrom Escuro

		CornerRadius = UDim.new(0, 15),
		ButtonCorner = UDim.new(0, 10),

		StrokeColor = Color3.fromRGB(155, 119, 81), -- Marrom Mais Escuro para Borda/Stroke
		StrokeThickness = 1,
		StrokeTransparency = 0
	}
}

-- Função helper para conectar eventos e salvar para cleanup
local function safeConnect(signal, func)
	local conn = signal:Connect(func)
	table.insert(connections, conn)
	return conn
end

-- Atualiza Character no spawn
local function setupCharacter(char)
	Character = char
	Humanoid = char:WaitForChild("Humanoid")
end

setupCharacter(Player.Character or Player.CharacterAdded:Wait())
safeConnect(Player.CharacterAdded, setupCharacter)

-- GUI
local GUI = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local TitleLabel = Instance.new("TextLabel")
local IslandLabel = Instance.new("TextLabel")
local StatusLabel = Instance.new("TextLabel")
local TeleportButton = Instance.new("TextButton")
local RefreshButton = Instance.new("TextButton")
local ThemeButton = Instance.new("TextButton")
local CloseButton = Instance.new("TextButton")

-- UICorners
local FrameCorner = Instance.new("UICorner")
local TeleportCorner = Instance.new("UICorner")
local RefreshCorner = Instance.new("UICorner")
local ThemeCorner = Instance.new("UICorner")
local CloseCorner = Instance.new("UICorner")

-- UIStrokes (NOVO: Para simular as bordas das ripas/painéis)
local FrameStroke = Instance.new("UIStroke")
local TeleportStroke = Instance.new("UIStroke")
local RefreshStroke = Instance.new("UIStroke")
local ThemeStroke = Instance.new("UIStroke")
local CloseStroke = Instance.new("UIStroke")

-- Parent dos Corners
FrameCorner.Parent = Frame
TeleportCorner.Parent = TeleportButton
RefreshCorner.Parent = RefreshButton
ThemeCorner.Parent = ThemeButton
CloseCorner.Parent = CloseButton

-- Parent dos Strokes (NOVO)
FrameStroke.Parent = Frame
TeleportStroke.Parent = TeleportButton
RefreshStroke.Parent = RefreshButton
ThemeStroke.Parent = ThemeButton
CloseStroke.Parent = CloseButton

GUI.Name = "TeleportGUI"
GUI.Parent = Player:WaitForChild("PlayerGui")
GUI.ResetOnSpawn = false

-- Frame Base
Frame.Name = "TPFrame"
Frame.Size = UDim2.new(0, 320, 0, 220)
Frame.Position = UDim2.new(0.5, -160, 0.5, -110)
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.BorderSizePixel = 0
Frame.Parent = GUI

-- Título
TitleLabel.Size = UDim2.new(1, -40, 0, 30)
TitleLabel.Position = UDim2.new(0, 10, 0, 5)
TitleLabel.Text = "TP Horse"
TitleLabel.Font = Enum.Font.SourceSansSemibold
TitleLabel.TextSize = 20
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = Frame

-- Rótulo da Ilha
IslandLabel.Name = "IslandLabel"
IslandLabel.Size = UDim2.new(1, -40, 0, 20)
IslandLabel.Position = UDim2.new(0, 10, 0, 35)
IslandLabel.Text = "Ilha: Buscando..."
IslandLabel.Font = Enum.Font.SourceSans
IslandLabel.TextSize = 14
IslandLabel.BackgroundTransparency = 1
IslandLabel.TextXAlignment = Enum.TextXAlignment.Left
IslandLabel.Parent = Frame

-- Botão de fechar (X)
CloseButton.Size = UDim2.new(0, 28, 0, 28)
CloseButton.Position = UDim2.new(1, -35, 0, 6)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 18
CloseButton.AutoButtonColor = false
CloseButton.Parent = Frame

-- Status
StatusLabel.Size = UDim2.new(1, -20, 0.35, 0)
StatusLabel.Position = UDim2.new(0, 10, 0.3, 0)
StatusLabel.Font = Enum.Font.SourceSans
StatusLabel.TextSize = 16
StatusLabel.TextWrapped = true
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.BackgroundTransparency = 1
StatusLabel.Parent = Frame

-- Botão Teleport
TeleportButton.Size = UDim2.new(0, 93, 0, 40)
TeleportButton.Position = UDim2.new(0, 10, 0.75, 0)
TeleportButton.Text = "TP"
TeleportButton.Font = Enum.Font.SourceSansSemibold
TeleportButton.TextSize = 18
TeleportButton.AutoButtonColor = false
TeleportButton.Parent = Frame

-- Botão Refresh
RefreshButton.Size = UDim2.new(0, 93, 0, 40)
RefreshButton.Position = UDim2.new(0, 114, 0.75, 0)
RefreshButton.Text = "Busca"
RefreshButton.Font = Enum.Font.SourceSansSemibold
RefreshButton.TextSize = 18
RefreshButton.AutoButtonColor = false
RefreshButton.Parent = Frame

-- Botão de Tema
ThemeButton.Size = UDim2.new(0, 93, 0, 40)
ThemeButton.Position = UDim2.new(1, -103, 0.75, 0)
ThemeButton.Text = "Tema"
ThemeButton.Font = Enum.Font.SourceSansSemibold
ThemeButton.TextSize = 18
ThemeButton.AutoButtonColor = false
ThemeButton.Parent = Frame

GUI.Enabled = false

-- Função para aplicar o estilo do tema
local function applyTheme(themeName)
	local theme = THEMES[themeName]
	if not theme then return end

	-- Frame Principal
	Frame.BackgroundColor3 = theme.FrameBG
	FrameCorner.CornerRadius = theme.CornerRadius
	FrameStroke.Color = theme.StrokeColor
	FrameStroke.Thickness = theme.StrokeThickness
	FrameStroke.Transparency = theme.StrokeTransparency

	-- Textos
	TitleLabel.TextColor3 = theme.TextPrimary
	StatusLabel.TextColor3 = theme.TextPrimary
	IslandLabel.TextColor3 = theme.TextSecondary

	-- Botões
	TeleportButton.BackgroundColor3 = theme.ButtonTP
	RefreshButton.BackgroundColor3 = theme.ButtonRefresh
	CloseButton.BackgroundColor3 = theme.ButtonClose
	ThemeButton.BackgroundColor3 = theme.ButtonTheme
	CloseButton.TextColor3 = theme.TextPrimary -- Mantém o X branco/claro
	
	TeleportButton.TextColor3 = theme.TextPrimary
	RefreshButton.TextColor3 = theme.TextPrimary
	ThemeButton.TextColor3 = theme.TextPrimary
	CloseButton.TextColor3 = theme.TextPrimary
	
	-- Corners dos Botões
	local bCorner = theme.ButtonCorner
	TeleportCorner.CornerRadius = bCorner
	RefreshCorner.CornerRadius = bCorner
	ThemeCorner.CornerRadius = bCorner
	CloseCorner.CornerRadius = bCorner

	-- Strokes dos Botões (NOVO)
	local bStrokeColor = theme.StrokeColor
	local bStrokeThickness = theme.StrokeThickness
	local bStrokeTransparency = theme.StrokeTransparency
	TeleportStroke.Color = bStrokeColor
	TeleportStroke.Thickness = bStrokeThickness
	TeleportStroke.Transparency = bStrokeTransparency
	RefreshStroke.Color = bStrokeColor
	RefreshStroke.Thickness = bStrokeThickness
	RefreshStroke.Transparency = bStrokeTransparency
	ThemeStroke.Color = bStrokeColor
	ThemeStroke.Thickness = bStrokeThickness
	ThemeStroke.Transparency = bStrokeTransparency
	CloseStroke.Color = bStrokeColor
	CloseStroke.Thickness = bStrokeThickness
	CloseStroke.Transparency = bStrokeTransparency

	currentTheme = themeName
end

-- Função para trocar o tema
local function toggleTheme()
	if currentTheme == "Discord" then
		applyTheme("Western")
	else
		applyTheme("Discord")
	end
end

-- Teleport logic (mantido o mesmo)
local validModels = {}
local currentModelIndex = 1

local function findValidModels()
	local islandsFolder = workspace:FindFirstChild("Islands")
	if not islandsFolder then
		warn("Pasta 'Islands' não encontrada no Workspace")
		return {}, "Erro: Islands Missing"
	end

	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Highlight") and obj.Name == "TeleportHighlight" then
			obj:Destroy()
		end
	end

	local playerIslandFolder = Character and Character.Parent
	local islandContainer = nil

	while playerIslandFolder and playerIslandFolder ~= islandsFolder and playerIslandFolder ~= workspace do
		if playerIslandFolder.Parent == islandsFolder then
			islandContainer = playerIslandFolder
			break
		end
		playerIslandFolder = playerIslandFolder.Parent
	end

	if not islandContainer then
		warn("Ilha do jogador não identificada dentro da pasta 'Islands'.")
		return {}, "Erro: Não na Ilha"
	end

	local islandName = islandContainer.Name
	local found = {}

	for _, descendant in ipairs(islandContainer:GetDescendants()) do
		if descendant:IsA("Model")
			and descendant:FindFirstChildOfClass("Humanoid")
			and descendant:FindFirstChild("HumanoidRootPart")
			and descendant.Name:match("^%b{}$") then

			local highlight = Instance.new("Highlight")
			highlight.Name = "TeleportHighlight"
			highlight.FillColor = Color3.fromRGB(88, 101, 242)
			highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
			highlight.FillTransparency = 0.5
			highlight.OutlineTransparency = 0
			highlight.Adornee = descendant
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			highlight.Parent = descendant

			table.insert(found, {
				Model = descendant,
				RootPart = descendant:FindFirstChild("HumanoidRootPart")
			})
		end
	end

	table.sort(found, function(a, b)
		return a.Model.Name < b.Model.Name
	end)

	return found, islandName
end

local function updateGUIStatus()
	if #validModels == 0 then
		StatusLabel.Text = "Nenhum cavalo encontrado com nome entre { }"
	else
		local modelInfo = validModels[currentModelIndex]
		local pos = modelInfo.RootPart.Position
		StatusLabel.Text = string.format("Cavalo %d de %d:\n%s\nPosição: %.1f, %.1f, %.1f",
			currentModelIndex,
			#validModels,
			modelInfo.Model.Name,
			pos.X, pos.Y, pos.Z)
	end
end

local function teleportToNextModel()
	if #validModels == 0 then
		StatusLabel.Text = "Nenhum cavalo encontrado com nome entre { }"
		return
	end

	currentModelIndex += 1
	if currentModelIndex > #validModels then
		currentModelIndex = 1
	end

	local target = validModels[currentModelIndex]
	if target and target.Model and target.RootPart and Character then
		Character:PivotTo(CFrame.new(target.RootPart.Position + Vector3.new(0, 3, 0)))
		updateGUIStatus()
	end
end

local function refreshHorseList()
	local islandName

	validModels, islandName = findValidModels()
	currentModelIndex = 1

	if islandName and islandName:sub(1, 4) == "Erro" then
		IslandLabel.Text = "Ilha: Falha na identificação"
	else
		IslandLabel.Text = "Ilha: " .. (islandName or "Desconhecida")
	end

	updateGUIStatus()
end

-- Cleanup total
local function cleanup()
	for _, conn in pairs(connections) do
		if conn.Connected then
			conn:Disconnect()
		end
	end
	connections = {}

	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Highlight") and obj.Name == "TeleportHighlight" then
			obj:Destroy()
		end
	end

	if GUI then
		GUI:Destroy()
	end
end

-- Conecta botões
safeConnect(TeleportButton.MouseButton1Click, teleportToNextModel)
safeConnect(RefreshButton.MouseButton1Click, refreshHorseList)
safeConnect(ThemeButton.MouseButton1Click, toggleTheme)
safeConnect(CloseButton.MouseButton1Click, cleanup)

-- Teclado
safeConnect(UIS.InputBegan, function(input, gameProcessed)
	if gameProcessed then return end

	if input.KeyCode == Enum.KeyCode.Z then
		teleportToNextModel()
	elseif input.KeyCode == Enum.KeyCode.X then
		refreshHorseList()
	elseif input.KeyCode == Enum.KeyCode.C then
		toggleTheme()
	end
end)

-- Arrastar GUI (mantido o mesmo)
local dragInput, mousePos, framePos

safeConnect(Frame.InputBegan, function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragInput = input
		mousePos = UIS:GetMouseLocation()
		framePos = Frame.Position

		safeConnect(input.Changed, function()
			if dragInput and dragInput.UserInputState == Enum.UserInputState.End then
				dragInput = nil
			end
		end)
	end
end)

safeConnect(RunService.Heartbeat, function()
	if dragInput then
		local delta = UIS:GetMouseLocation() - mousePos
		Frame.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
	end
end)

-- Inicializa
task.wait(1)
applyTheme(currentTheme)
refreshHorseList()
GUI.Enabled = true
